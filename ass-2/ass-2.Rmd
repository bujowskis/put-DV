---
title: 'Assignment 2: Grammar of Graphics'
author: "Szymon Bujowski, Preetam Sharma"
output:
  html_document:
    toc: true               # table of contents
    number_sections: true   # headings enumeration
    toc_float: true         # floating toc
    theme: united           # looks&feels
    highlight: tango        # as above
---

# Foreword

The following document is an assignment for Poznan University of Technology's Data Visualization course. The course is conducted by Dariusz Brzeziński during the 4th semester of Artificial Intelligence Bachelor degree.

The assignment is an implementation of the grammar of graphics, intended to create rich visualizations from the data we were provided with. The data consists of two datasets, for both of which we've chosen the upcoming visualizations. As it is stated in the assignment description:

* The data in the Sectors folder present the percentage changes of stock prices and trading volume in selected sectors
    + Some of the datasets also contain information about the media sentiment about the companies
* The Correlations.csv dataset contains correlations between the stock prices of pairs of companies identified by stock symbols (tickers)

For both the following visualizations, we will provide brief descriptions and reasoning behind them.

## Credits

We have to credit the lecturer, **Dariusz Brzeziński**, for the interactive tables we have used. They were built using the `DT` package.

The tables should work as intended in html format of the document, however interactivity will be lost in pdf format.

```{r db_table, echo=FALSE, message=FALSE, warning=FALSE}
library(DT)

# credit: Dariusz Brzeziński
prettyTable <- function(table_df, round_columns_func=is.numeric, round_digits=2) {
    DT::datatable(table_df, style="bootstrap", filter = "top", rownames = FALSE, extensions = "Buttons", options = list(dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>%
    formatRound(unlist(lapply(table_df, round_columns_func)), round_digits)
}
```

# Treemap 

TODO

```{python}
...
```

# Correlations

## The data

```{r cor_data, echo=FALSE, message=FALSE, warning=FALSE}
cor_data = read.csv("Dataset/Correlations.csv")
prettyTable(cor_data)
```

## Sketch

Static visualization choice for the correlations was pretty obvious from the beginning - a heat map correlation matrix. For that reason, there was really no sketch here.

Regarding handling situations in which there is some correlation value missing, it sufficed to use `NA` value, which would result in a missing tile in the visualization.

However, there was no such situations in this case, and thus this feature cannot be seen.

## The visualization

```{r fig.align="center", fig.width=20, fig.height=20, echo=TRUE, results='hide', message=FALSE, warning=FALSE,  fig.keep='all'}
library(ggplot2)
library(plotly)

# get all unique tickers
ut <- data.frame(tickers=union(cor_data$Ticker.1, cor_data$Ticker.2))
rut <- data.frame(tickers=rev(ut$tickers))  # save a reversed copy for later

# create dataframe of all combinations
df <- expand.grid(ticker1=rut$tickers, ticker2=ut$tickers)

# read the correlation values
df$val <- NA # correlation not specified, cell will be colored black
for (i in 1:nrow(cor_data)) {
  # read from the dataset
  df$val[length(ut$tickers)*(match(cor_data$Ticker.1[i], ut$tickers) - 1) +
               match(cor_data$Ticker.2[i], rut$tickers)] = cor_data$Correlation.Value[i]
  # it's bidirectional
  df$val[length(ut$tickers)*(match(cor_data$Ticker.2[i], ut$tickers) - 1) +
               match(cor_data$Ticker.1[i], rut$tickers)] = cor_data$Correlation.Value[i]
}
j = length(ut$tickers)
for (i in 0:(length(ut$tickers) - 1)) {
  # remove upper triangle
  for (k in 0:i) {
    df$val[j - k] = NA
  }
  j = j + length(ut$tickers)
}
for (i in 0:(length(ut$tickers) - 1)) {
  # correlation = 1 between the same stock
  df$val[length(ut$tickers) + i*(length(ut$tickers) - 1)] = 1
}

# text for tooltip
df <- df %>%
  mutate(text = paste0(df$ticker1, "\n", df$ticker2, "\n", "Val: ", df$val))

# Heatmap 
p = ggplot(df, aes(ticker1, ticker2, fill=val)) + 
  geom_tile() +
  geom_text(aes(label=round(val, 2)),
            size=6
            ) +
  #scale_x_discrete(guide=guide_axis(n.dodge=2)) +
  theme(axis.title.x=element_blank(),  # remove x axis title
        axis.title.y=element_blank(),  # remove y axis title,
        text=element_text(size=20),
        axis.text=element_text(size=20),
        legend.key.size = unit(2, 'cm'),
        legend.key.height = unit(2, 'cm'),
        legend.key.width = unit(2, 'cm'),
        axis.text.x=element_text(angle=45, hjust=1)
        ) +
  scale_fill_gradient2(low="white", high="blue",
                       limits=c(c(0, 1)),
                       na.value="white"
                       ) +
  ggtitle("Stocks correlation matrix")
p
```
